name: SecureOpsFlow Workflow

on:
  push:
    branches:
      - main

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v4
        with:
          args: >
            -Dsonar.projectKey=SecureOpsFlow_SonarQube_Analysis
            -Dsonar.sources=.
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      - name: Check SonarQube Quality Gate
        id: quality-gate
        run: |
          status=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
          "${{ secrets.SONAR_HOST_URL }}/api/qualitygates/project_status?projectKey=SecureOpsFlow_SonarQube_Analysis" | jq -r '.projectStatus.status')
          echo "Quality Gate Status: $status"
          if [[ "$status" != "OK" ]]; then  
            echo "Quality Gate failed"
            exit 1
          fi


      # - name: Notify Developer on Failure
      #   if: failure()
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.example.com
      #     server_port: 587
      #     username: ${{ secrets.EMAIL_USER }}
      #     password: ${{ secrets.EMAIL_PASS }}
      #     to: developer@example.com
      #     subject: "Code Quality Check Failed"
      #     body: "The code quality check has failed. Please review the logs."

      # - name: Run SonarQube Scan
      #   uses: sonarsource/sonarqube-scan-action@v4
      #   with:
      #     args: >
      #       -Dsonar.projectKey=SecureOpsFlow_SonarQube_Analysis
      #       -Dsonar.sources=.
      #       -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}
      #       -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      # # - name: SonarQube Quality Gate Check
      # #   id: sonarqube-quality-gate-check
      # #   uses: sonarsource/sonarqube-quality-gate-action@v1.0.0
      # #   with:
      # #     pollingTimeoutSec: 600
      # #   env:
      # #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      # #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      # #   continue-on-error: true

      # - name: SonarQube Server Quality Gate check
      #   id: sonarqube-quality-gate-check
      #   uses: sonarsource/sonarqube-quality-gate-action@master
      #   with:
      #     pollingTimeoutSec: 600
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }} #OPTIONAL

      # - name: Get SonarQube Quality Gate Status
      #   run: |
      #     curl -u "admin:Pawan@8827209340" \
      #       "http://${{ secrets.SONAR_HOST_URL }}/api/qualitygates/project_status?projectKey=SecureOpsFlow_SonarQube_Analysis"
      #   continue-on-error: true
